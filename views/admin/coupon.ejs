<%- include("../../views/partial/admin/header") %>
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3">Coupon Management</h1>
            <p class="text-muted">Manage your discount coupons</p>
        </div>
        <div>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCouponModal">
                <i class="fas fa-plus me-2"></i>Add New Coupon
            </button>
        </div>
    </div>

    <!-- Search and Filter Bar -->
    <div class="card mb-4">
        <div class="card-body">
            <form class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-transparent border-end-0">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" class="form-control border-start-0 ps-0" placeholder="Search coupons...">
                        <button class="btn btn-primary" type="submit">Search</button>
                        <button class="btn btn-secondary" type="button">Clear</button>
                    </div>
                </div>
                <div class="col-md-2">
                    <select class="form-select">
                        <option value="">All Types</option>
                        <option value="percentage">Percentage</option>
                        <option value="fixed">Fixed Amount</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select">
                        <option value="">All Status</option>
                        <option value="active">Active</option>
                        <option value="expired">Expired</option>
                        <option value="disabled">Disabled</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="date" class="form-control" placeholder="Expiry Date">
                </div>
            </form>
        </div>
    </div>

    <!-- Coupon Table -->
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover align-middle coupon-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Code</th>
                            <th>Discount</th>
                            <th>Type</th>
                            <th>Min Purchase</th>
                            <th>Max Discount</th>
                            <th>Expiry</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Sample Coupon 1 -->
                        <tr data-id="1">
                            <td>1</td>
                            <td class="fw-medium">SAVE20</td>
                            <td>20%</td>
                            <td>Percentage</td>
                            <td>$50</td>
                            <td>$100</td>
                            <td>2025-06-30</td>
                            <td>
                                <button class="btn btn-sm status-btn bg-success text-white" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#statusModal" 
                                        data-id="1" 
                                        data-code="SAVE20" 
                                        data-status="Active">
                                    <span class="status-text">Active</span>
                                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                </button>
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-info view-btn" title="View details" data-id="1">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary edit-btn" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editCouponModal" 
                                            data-id="1" 
                                            title="Edit coupon">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-btn" title="Delete coupon" data-id="1">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <!-- Sample Coupon 2 -->
                        <tr data-id="2">
                            <td>2</td>
                            <td class="fw-medium">FLAT50</td>
                            <td>$50</td>
                            <td>Fixed</td>
                            <td>$200</td>
                            <td>-</td>
                            <td>2025-04-15</td>
                            <td>
                                <button class="btn btn-sm status-btn bg-success text-white" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#statusModal" 
                                        data-id="2" 
                                        data-code="FLAT50" 
                                        data-status="Active">
                                    <span class="status-text">Active</span>
                                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                </button>
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-info view-btn" title="View details" data-id="2">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary edit-btn" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editCouponModal" 
                                            data-id="2" 
                                            title="Edit coupon">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-btn" title="Delete coupon" data-id="2">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <!-- Sample Coupon 3 -->
                        <tr data-id="3">
                            <td>3</td>
                            <td class="fw-medium">WELCOME10</td>
                            <td>10%</td>
                            <td>Percentage</td>
                            <td>$30</td>
                            <td>$50</td>
                            <td>2025-03-31</td>
                            <td>
                                <button class="btn btn-sm status-btn bg-danger text-white" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#statusModal" 
                                        data-id="3" 
                                        data-code="WELCOME10" 
                                        data-status="Expired">
                                    <span class="status-text">Expired</span>
                                    <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                                </button>
                            </td>
                            <td>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-sm btn-outline-info view-btn" title="View details" data-id="3">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary edit-btn" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#editCouponModal" 
                                            data-id="3" 
                                            title="Edit coupon">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-btn" title="Delete coupon" data-id="3">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div class="d-flex justify-content-between align-items-center mt-4">
                <div class="text-muted">
                    Showing <span class="fw-bold">1</span> to <span class="fw-bold">3</span> of <span class="fw-bold">3</span> Coupons
                </div>
                <nav aria-label="Page navigation">
                    <ul class="pagination mb-0">
                        <li class="page-item disabled">
                            <a class="page-link" href="#" aria-label="Previous">
                                <i class="fas fa-chevron-left"></i>
                            </a>
                        </li>
                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                        <li class="page-item disabled">
                            <a class="page-link" href="#" aria-label="Next">
                                <i class="fas fa-chevron-right"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- Add Coupon Modal -->
<div class="modal fade" id="addCouponModal" tabindex="-1" aria-labelledby="addCouponModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCouponModalLabel">Add New Coupon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addCouponForm">
                    <div class="mb-3">
                        <label class="form-label">Coupon Code</label>
                        <input type="text" class="form-control" name="code" placeholder="e.g., SAVE20">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Discount Type</label>
                        <select class="form-select" name="type">
                            <option value="Percentage">Percentage</option>
                            <option value="Fixed">Fixed Amount</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Discount Value</label>
                        <input type="number" class="form-control" name="discount" placeholder="e.g., 20">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Minimum Purchase</label>
                        <input type="number" class="form-control" name="minPurchase" placeholder="e.g., 50">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Maximum Discount (optional)</label>
                        <input type="number" class="form-control" name="maxDiscount" placeholder="e.g., 100">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Expiry Date</label>
                        <input type="date" class="form-control" name="expiry">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveNewCoupon">Save Coupon</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Coupon Modal -->
<div class="modal fade" id="editCouponModal" tabindex="-1" aria-labelledby="editCouponModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCouponModalLabel">Edit Coupon</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editCouponForm">
                    <input type="hidden" name="id">
                    <div class="mb-3">
                        <label class="form-label">Coupon Code</label>
                        <input type="text" class="form-control" name="code" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Discount Type</label>
                        <select class="form-select" name="type">
                            <option value="Percentage">Percentage</option>
                            <option value="Fixed">Fixed Amount</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Discount Value</label>
                        <input type="number" class="form-control" name="discount">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Minimum Purchase</label>
                        <input type="number" class="form-control" name="minPurchase">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Maximum Discount (optional)</label>
                        <input type="number" class="form-control" name="maxDiscount">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Expiry Date</label>
                        <input type="date" class="form-control" name="expiry">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="saveEditCoupon">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Confirmation Modal -->
<div class="modal fade" id="editConfirmModal" tabindex="-1" aria-labelledby="editConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editConfirmModalLabel">Confirm Edit</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="editConfirmMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmEdit">Confirm</button>
            </div>
        </div>
    </div>
</div>

<!-- Status Change Modal -->
<div class="modal fade" id="statusModal" tabindex="-1" aria-labelledby="statusModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusModalLabel">Change Coupon Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="statusMessage"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmStatus">Confirm</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const themeToggle = document.getElementById('themeToggle');
        const body = document.body;

        // Theme Toggle
        themeToggle.addEventListener('click', () => {
            if (body.classList.contains('light-mode')) {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
            }
        });

        // Status Change
        const statusModal = document.getElementById('statusModal');
        let currentCouponId = '';

        statusModal.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            currentCouponId = button.getAttribute('data-id');
            const currentStatus = button.getAttribute('data-status');
            const couponCode = button.getAttribute('data-code');
            const newStatus = currentStatus === 'Active' ? 'Disabled' : 'Active';

            document.getElementById('statusMessage').textContent = 
                `Are you sure you want to change "${couponCode}" from ${currentStatus} to ${newStatus}?`;
            document.getElementById('confirmStatus').className = `btn ${newStatus === 'Active' ? 'btn-success' : 'btn-danger'}`;
        });

        document.getElementById('confirmStatus').addEventListener('click', () => {
            const button = document.querySelector(`.status-btn[data-id="${currentCouponId}"]`);
            const statusText = button.querySelector('.status-text');
            const currentStatus = button.getAttribute('data-status');
            const newStatus = currentStatus === 'Active' ? 'Disabled' : 'Active';

            // Simulate loading
            statusText.classList.add('d-none');
            button.querySelector('.spinner-border').classList.remove('d-none');

            setTimeout(() => {
                // Update UI
                statusText.textContent = newStatus;
                button.classList.remove('bg-success', 'bg-danger');
                button.classList.add(newStatus === 'Active' ? 'bg-success' : 'bg-danger');
                button.setAttribute('data-status', newStatus);
                statusText.classList.remove('d-none');
                button.querySelector('.spinner-border').classList.add('d-none');

                bootstrap.Modal.getInstance(statusModal).hide();
                alert(`Status updated to ${newStatus}`);
            }, 1000);
        });

        // Edit Coupon
        const editCouponModal = document.getElementById('editCouponModal');
        const editConfirmModal = document.getElementById('editConfirmModal');
        let editCouponData = {};

        editCouponModal.addEventListener('show.bs.modal', (event) => {
            const button = event.relatedTarget;
            const couponId = button.getAttribute('data-id');
            const row = document.querySelector(`tr[data-id="${couponId}"]`);
            
            editCouponData = {
                id: couponId,
                code: row.cells[1].textContent,
                discount: row.cells[2].textContent,
                type: row.cells[3].textContent,
                minPurchase: row.cells[4].textContent,
                maxDiscount: row.cells[5].textContent === '-' ? '' : row.cells[5].textContent,
                expiry: row.cells[6].textContent
            };

            const form = document.getElementById('editCouponForm');
            form.querySelector('[name="id"]').value = editCouponData.id;
            form.querySelector('[name="code"]').value = editCouponData.code;
            form.querySelector('[name="type"]').value = editCouponData.type;
            form.querySelector('[name="discount"]').value = editCouponData.discount.replace(/[^0-9]/g, '');
            form.querySelector('[name="minPurchase"]').value = editCouponData.minPurchase.replace(/[^0-9]/g, '');
            form.querySelector('[name="maxDiscount"]').value = editCouponData.maxDiscount.replace(/[^0-9]/g, '');
            form.querySelector('[name="expiry"]').value = editCouponData.expiry;
        });

        document.getElementById('saveEditCoupon').addEventListener('click', () => {
            const form = document.getElementById('editCouponForm');
            editCouponData = {
                id: form.querySelector('[name="id"]').value,
                code: form.querySelector('[name="code"]').value,
                type: form.querySelector('[name="type"]').value,
                discount: form.querySelector('[name="discount"]').value,
                minPurchase: form.querySelector('[name="minPurchase"]').value,
                maxDiscount: form.querySelector('[name="maxDiscount"]').value,
                expiry: form.querySelector('[name="expiry"]').value
            };

            document.getElementById('editConfirmMessage').textContent = 
                `Are you sure you want to save changes to "${editCouponData.code}"?`;
            bootstrap.Modal.getInstance(editCouponModal).hide();
            new bootstrap.Modal(document.getElementById('editConfirmModal')).show();
        });

        document.getElementById('confirmEdit').addEventListener('click', () => {
            const row = document.querySelector(`tr[data-id="${editCouponData.id}"]`);
            row.cells[2].textContent = editCouponData.type === 'Percentage' ? `${editCouponData.discount}%` : `$${editCouponData.discount}`;
            row.cells[3].textContent = editCouponData.type;
            row.cells[4].textContent = `$${editCouponData.minPurchase}`;
            row.cells[5].textContent = editCouponData.maxDiscount ? `$${editCouponData.maxDiscount}` : '-';
            row.cells[6].textContent = editCouponData.expiry;

            bootstrap.Modal.getInstance(editConfirmModal).hide();
            alert('Coupon updated successfully');
        });
    });
</script>
<%- include("../../views/partial/admin/footer") %>